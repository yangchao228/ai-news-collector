import fs from 'fs/promises';
import path from 'path';

/**
 * é£ä¹¦æŠ¥å‘Šç”Ÿæˆå™¨
 * å°†å¤„ç†åçš„æ–‡ç« ç”Ÿæˆä¸ºé£ä¹¦æ–‡æ¡£æ ¼å¼
 */
export class FeishuReporter {
  constructor() {
    this.outputDir = './output';
  }

  /**
   * ç”Ÿæˆé£ä¹¦æ–‡æ¡£æ ¼å¼çš„Markdown
   */
  async generateReport(dataFile) {
    const data = JSON.parse(await fs.readFile(dataFile, 'utf-8'));
    const { grouped, generatedAt, totalArticles } = data;
    
    const date = new Date(generatedAt).toLocaleDateString('zh-CN');
    
    let markdown = `# ğŸ¤– AIåº”ç”¨æ–¹å‘ä¿¡æ¯æ—¥æŠ¥

> ğŸ“… ç”Ÿæˆæ—¶é—´: ${date}  
> ğŸ“Š æ€»è®¡: ${totalArticles} ç¯‡æ–‡ç«   
> ğŸ”„ æ•°æ®æ¥æº: Daniel Miessler RSS

---

`;

    // æŒ‰é‡è¦æ€§æ’åºçš„ç²¾é€‰æ–‡ç« 
    const topArticles = Object.values(grouped)
      .flat()
      .sort((a, b) => b.importance - a.importance)
      .slice(0, 5);

    markdown += `## ğŸ”¥ ä»Šæ—¥ç²¾é€‰ (Top 5)

`;
    topArticles.forEach((article, i) => {
      markdown += `### ${i + 1}. ${article.title}

`;
      markdown += `- **æ¥æº**: ${article.source}  
`;
      markdown += `- **åˆ†ç±»**: ${article.category}  
`;
      markdown += `- **å‘å¸ƒæ—¶é—´**: ${new Date(article.pubDate).toLocaleDateString('zh-CN')}  
`;
      markdown += `- **é‡è¦æ€§**: ${'â­'.repeat(Math.floor(article.importance / 2))}  
`;
      markdown += `- **é“¾æ¥**: [é˜…è¯»åŸæ–‡](${article.link})  

`;
      markdown += `> ${article.summary}\n\n`;
      markdown += `---\n\n`;
    });

    // æŒ‰ç±»åˆ«åˆ†ç»„
    markdown += `## ğŸ“‘ åˆ†ç±»æµè§ˆ\n\n`;
    
    for (const [category, articles] of Object.entries(grouped)) {
      markdown += `### ${category} (${articles.length}ç¯‡)\n\n`;
      
      articles.forEach(article => {
        markdown += `#### ${article.title}\n\n`;
        markdown += `- ğŸ“… ${new Date(article.pubDate).toLocaleDateString('zh-CN')}  `;
        markdown += `| â­ ${article.importance}/10  `;
        markdown += `| [é˜…è¯»](${article.link})\n\n`;
        markdown += `> ${article.summary}\n\n`;
      });
      
      markdown += `\n`;
    }

    // æ·»åŠ ç³»ç»Ÿè¯´æ˜
    markdown += `---

## â„¹ï¸ å…³äºæœ¬ç³»ç»Ÿ

æœ¬ç³»ç»ŸåŸºäº [PAI (Personal AI Infrastructure)](https://github.com/danielmiessler/Personal_AI_Infrastructure) ç†å¿µæ„å»ºï¼š

- **ç›®æ ‡å¯¼å‘**: èšç„¦AIåº”ç”¨æ–¹å‘çš„ä¿¡æ¯æœé›†
- **æŒç»­å­¦ä¹ **: æ ¹æ®é˜…è¯»åé¦ˆä¼˜åŒ–æ¨è
- **ç”¨æˆ·ä¸­å¿ƒ**: ä»¥ä½ çš„éœ€æ±‚ä¸ºæ ¸å¿ƒï¼ŒéæŠ€æœ¯å±•ç¤º

### ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

1. â° è‡ªåŠ¨åŒ–å®šæ—¶æŠ“å–
2. ğŸ“š æ”¯æŒæ›´å¤šRSSæº
3. ğŸ¯ ä¸ªæ€§åŒ–æ¨è
4. ğŸ” å…¨æ–‡æ£€ç´¢
5. ğŸ’¬ ç”¨æˆ·åé¦ˆæ”¶é›†

---

*Generated by AI News Collector MVP*
`;

    return markdown;
  }

  /**
   * ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
   */
  async saveReport(dataFile) {
    const markdown = await this.generateReport(dataFile);
    const outputFile = dataFile.replace('.json', '.md');
    
    await fs.writeFile(outputFile, markdown, 'utf-8');
    console.log(`ğŸ“ é£ä¹¦æ–‡æ¡£æ ¼å¼æŠ¥å‘Šå·²ç”Ÿæˆ: ${outputFile}`);
    
    return { markdown, outputFile };
  }
}

// CLIå…¥å£
async function main() {
  const reporter = new FeishuReporter();
  
  // æ‰¾åˆ°æœ€æ–°çš„digestæ–‡ä»¶
  const files = await fs.readdir('./output');
  const digestFiles = files.filter(f => f.startsWith('digest-') && f.endsWith('.json'));
  
  if (digestFiles.length === 0) {
    console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ•°æ®æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ npm run collect');
    return;
  }
  
  // æŒ‰æ–‡ä»¶åæ’åºï¼Œå–æœ€æ–°çš„
  digestFiles.sort().reverse();
  const latestFile = path.join('./output', digestFiles[0]);
  
  console.log('ğŸ“ æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...');
  const result = await reporter.saveReport(latestFile);
  
  console.log('\n' + 'â•'.repeat(50));
  console.log('æŠ¥å‘Šé¢„è§ˆ (å‰500å­—ç¬¦):');
  console.log('â•'.repeat(50));
  console.log(result.markdown.substring(0, 500) + '...');
}

main().catch(console.error);